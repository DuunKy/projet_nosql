<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Évolution des Constructeurs - F1</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }

    .chart-container {
      height: 400px;
      overflow-x: auto;
      margin-top: 30px;
    }

    .chart-wrapper {
      min-width: 600px;
      height: 100%;
    }

    canvas {
      height: 100% !important;
      width: 100% !important;
    }

    #seasonSelect {
      max-width: 200px;
    }
  </style>
</head>
<body class="container py-4">
  <h2 class="text-center mb-4">Classement des Écuries par Saison</h2>

  <div class="mb-3 text-center">
    <label for="seasonSelect" class="form-label fw-bold">Choisir une saison :</label>
    <select id="seasonSelect" class="form-select d-inline-block" onchange="onSeasonChange()">
      <option selected disabled>-- Saison --</option>
    </select>
  </div>

  <div id="chartContainer" class="chart-container d-none">
    <div class="chart-wrapper">
      <canvas id="evoChart"></canvas>
    </div>
  </div>

  <script>
    const baseURL = "http://127.0.0.1:5000/api/v1/";
    let constructors = [];
    let chartInstance = null;

    async function fetchJSON(url) {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("Erreur");
        return await res.json();
      } catch {
        return null;
      }
    }

    async function initSeasonSelector() {
      const seasonsData = await fetchJSON(baseURL + "seasons");
      const constructorsData = await fetchJSON(baseURL + "constructors");
      if (!seasonsData || !constructorsData) return;

      constructors = constructorsData.data;
      const sortedSeasons = seasonsData.data.sort((a, b) => a.year - b.year);
      const seasonSelect = document.getElementById("seasonSelect");

      for (const { year } of sortedSeasons) {
        const isValid = await isSeasonAvailable(year);
        if (isValid) {
          const option = document.createElement("option");
          option.value = year;
          option.textContent = year;
          seasonSelect.appendChild(option);
        }
      }
    }

    async function isSeasonAvailable(year) {
      for (const c of constructors) {
        const url = `${baseURL}constructors/${c.constructorId}/standing-evolution?season=${year}`;
        try {
          const res = await fetch(url);
          if (res.ok) return true; // Une seule réponse 200 suffit
        } catch {
          continue;
        }
      }
      return false;
    }

    async function onSeasonChange() {
      const season = document.getElementById("seasonSelect").value;
      if (!season) return;

      await loadChartForSeason(season);
    }

    async function loadChartForSeason(season) {
      const datasets = [];
      let labels = [];

      for (const c of constructors) {
        const evoData = await fetchJSON(`${baseURL}constructors/${c.constructorId}/standing-evolution?season=${season}`);
        if (!evoData || !evoData.evolution) continue;

        if (labels.length === 0) {
          labels = evoData.evolution.map(e => "M" + e.round);
        }

        datasets.push({
          label: c.name,
          data: evoData.evolution.map(e => e.position),
          borderColor: getRandomColor(),
          fill: false,
          tension: 0.3
        });
      }

      if (chartInstance) {
        chartInstance.destroy();
      }

      if (datasets.length === 0) {
        document.getElementById("chartContainer").classList.add("d-none");
        return;
      }

      document.getElementById("chartContainer").classList.remove("d-none");
      const ctx = document.getElementById("evoChart").getContext("2d");

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: `Classement des écuries - ${season}`,
              font: {
                size: 16
              }
            },
            legend: {
              position: 'bottom',
              labels: {
                font: { size: 10 },
                boxWidth: 12
              }
            }
          },
          scales: {
            y: {
              reverse: true,
              ticks: { stepSize: 1 },
              title: {
                display: true,
                text: 'Position'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Manche'
              }
            }
          }
        }
      });
    }

    function getRandomColor() {
      const r = Math.floor(Math.random() * 200);
      const g = Math.floor(Math.random() * 200);
      const b = Math.floor(Math.random() * 200);
      return `rgba(${r}, ${g}, ${b}, 1)`;
    }

    initSeasonSelector();
  </script>
</body>
</html>
